<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>

<!-- This was written be Andrew Keeling in notepad, and polished a little by Michael Carden. -->
<link rel=stylesheet href="../howto.css" type="text/css"/>
<title>Setup</title>
</head>

<body>

<h2 style="text-align: center;">WRITING A SIMPLE
NORMALISER PLUGIN&nbsp;</h2>

<h4>1 - SETUP</h4>

<div id="content">
<h4>Prerequisites</h4>
To begin writing a Xena normaliser plugin, you will need:<br>
<br>
An installation of Xena. http://xena.sourceforge.net<br>
An installation of Apache Ant. http://ant.apache.org<br>
An installation of the SUN jdk. http://java.sun.com/j2se/1.5.0/download.jsp
<h4>A New File Format</h4>

We have a requirement to create a
normaliser for a brand new file format. This file format, the 'foo'
file format, is the mainstay of organisation X, and is specified as
follows:
All 'foo' files are UTF-8 text or ASCII, and should have the extension
'foo', and begin with the sequence of characters:
<br>

<br>

~beginfoo~
<br>

<br>

After that, a foo file is partitioned into parts delineated with the
'~' character. The '\' character is used as an escape sequence, if it
is followed by a '~' or '\' character these characters are taken as
literal, otherwise the '\' is ignored. At this stage, this is all we
are going to be concerned with, and when we preserve&nbsp;'foo'
files,
we will be preserving each part of the file as a separate piece of XML.
<br>

<br>

It is possible that some&nbsp;files will not have the correct
filename
extension, it is also possible that some files which are not 'foo'
files will have the foo extension.
Organisation X&nbsp; proposes that the XML schema for the
preserved 'foo' file format will be as such:
<pre>&#60foo&#62<br>&#60part&#62SOME DATA&#60/part&#62<br>&#60part&#62MORE DATA, AN EMPTY PART FOLLOWS&#60/part&#62<br>&#60/part&#62<br>&#60part&#62FINAL PART OF FOO FILE&#60/part&#62<br>&#60/foo&#62<br></pre>

<h4>First Steps </h4>

The very first step we will undertake is to create an outline of the
plugin that will be loaded by Xena. Xena expects plugins to be loaded
as JAR files, laid out in a specific way. To aid in this, the Apache
Ant build tool will be used. To set up our plugin development
directory, we will create a new folder, called foo_plugin, at an
arbitrary place in the filesystem. This folder will be called the home
folder, and designated by "~/" so our plugin will be contained in
"~/foo_plugin". For Windows users, switch the "/" to "\", and the "~"
to something like "C:\Documents and Settings\UserName\My Documents".
<br>

<br>

So to start off with, we get all the components we need to make a
plugin. The first is the "name.properties" file. This file should be
loaded in the base directory of the JAR file, and should contain the
fully qualified name of the package where the Java classes that are
doing the work in the plugin will live. In this example, we will be
putting all our classes in the package:<br>

<br>

au.gov.naa.digipres.xena.demo.foo<br>

<br>

At this stage, the name.properties file should contain the name of the
package with '/'s instead of '.'s.

So here is the content of our name.properties file:
<pre>name=au/gov/naa/digipres/xena/demo/foo<br></pre>

Thats it. Just the name of the package where we can expect to find the
bits of the plugin that will be doing the work with slashes instead of
dots for separators. The next thing we have
to do is create the source folder for the package, and put&nbsp;the
name.properties file inside that. <br>

<br>

In this example, the source will be
created in the folder named 'src', and the output of any compiling will
go to 'bin', and a dist folder will contain the built JAR file. Any
configuration files will be put into a folder named 'etc', and finally,
any required external libraries (probably in JAR form) will be stored
in the 'ext' folder. At the end of setting up our folder structure, we
should have the following entries in the "~/foo_plugin" folder:
<pre> - /bin<br> - /dist<br> - /etc<br> - /ext<br> - /src<br> - name.properties<br></pre>

Now, to make this all happen simply, we will create an Ant build file
to do it all automatically. A sample build file is available here. Of
note in the build file are the following sections.
First up, we will set up a bunch of properties to set the name of the
plugin, and match the folder structure used in our project.
<div id="ant">
	<pre>&#60property name="pluginname" value="foo"/&#62<br>&#60property name="srcdir" value="src"/&#62<br>&#60property name="etcdir" value="etc"/&#62<br>&#60property name="builddir" value="bin"/&#62<br>&#60property name="distdir" value="dist"/&#62<br>&#60property name="extdir" value="ext"/&#62<br></pre>

</div>

Now we set the location of the xena.jar file in a property named,
appropriately, xenajarlocation. This is the most likely property to
need changing, unless you happen to have the xena file in the same
relative
location.
<div id="ant">
<pre>
&#60!-- required project jar files --&#62
&#60property name="xenajarlocation" value="../../xena/xena.jar" /&#62
</pre>

</div>

The next thing we do is create the compile path, to be used when
compiling our plugins.
<div id="ant">
<pre>
&#60path id="compile.path"&#62
	&#60fileset dir="ext"&#62
		&#60include name="**/*.jar"/&#62
	&#60/fileset&#62
	&#60pathelement location="${xenajar}"/&#62
&#60/path&#62

</pre>

</div>

Then the actual compile job itself, broken into a couple of lines.
<div id="ant">
<pre>&#60target name="compile" description="--&#62Compile the .java sources"&#62
		&#60javac srcdir="${srcdir}" destdir="${builddir}" debug="on"
			verbose="on" classpathref="compile.path"/&#62
&#60/target&#62<br></pre>

</div>

And finally the makejar job:
<div id="ant">
<pre>&#60target name="makejar" description="--&#62Make the jar file" depends="compile"&#62
	&#60delete &#62
		&#60fileset file="${distdir}/${pluginname}.jar"/&#62
	&#60/delete&#62
	&#60jar jarfile="${distdir}/${pluginname}.jar" manifest="etc/MANIFEST.MF"&gt;
		&#60fileset dir="${builddir}" &#62&#60include name="**/*.class"/ &#62&#60/fileset&#62
		&#60fileset dir="." &#62&#60include name = "name.properties"/&#62&#60/fileset&#62
		&#60fileset dir="${srcdir}"&#62&#60include name = "**/*.properties"/&#62&#60/fileset&#62
	&#60/jar&#62
&#60/target&#62
</pre>

</div>

It turns out we have almost the whole ant build file here.
Inside the Ant file is also a clean job, which deletes then
recreates the bin and dist folders.
<br>

Astute readers will have noticed a reference to the manifest for the
JAR file in the makejar target. Since there will be no main class in
our plugin Jar, all we will include in our manifest file will be the
line:<br>
<br>
Manifest-Version: 1.0
<br>
<br>

The manifest file should be created and exist in the etc folder, as
specified in the ant build job. Also, the makejar job looks for the
'name.properties' file in the base directory, and any properties files
in the src directory tree.
<br>

Our next job will be to create our preferences.properties file in the
source tree. This file will tell Xena what it is we can expect to find
in the plugin. It specifies any normalisers, types, guessers, file
namers, meta data package wrappers, help sets, basically anything that
can be in a normaliser. For the moment, we will leave it almost
entirely blank - the only thing we will include is the version number
of our plugin.
<br>

So, our preferences.properties file content will be:
<div id="properties">
<pre>version = 2.0.0<br></pre>

</div>

Now this file is expected to be in the JAR at the location:
'au/gov/naa/digipres/xena/demo/foo'. To make this happen, we will stick
it into that location in the source tree.
<br>

So, several make directory commands later, we now have the folder:
<pre>~/foo_plugin/src/au/gov/naa/digipres/xena/demo/foo<br></pre>

And it contains a single file, that being "prefences.properties".
To see that everything is going well, it is time to build our (empty)
foo plugin for the first time. In a command shell, at the location
'~/foo_plugin', type ant. If everything works, a JAR file, named
foo.jar will now exist in the folder 'dist'. Running the command 'jar
-tvf foo.jar' reveals the contents of the jar as such:
<div id="output">
<pre>
#jar -tvf foo.jar
0 Thu Feb 23 16:53:04 EST 2006 META-INF/
106 Thu Feb 23 16:53:02 EST 2006 META-INF/MANIFEST.MF
40 Thu Feb 23 12:35:10 EST 2006 name.properties
0 Thu Feb 23 16:50:20 EST 2006 au/
0 Thu Feb 23 16:50:26 EST 2006 au/gov/
0 Thu Feb 23 16:50:30 EST 2006 au/gov/naa/
0 Thu Feb 23 16:50:38 EST 2006 au/gov/naa/digipres/
0 Thu Feb 23 16:50:44 EST 2006 au/gov/naa/digipres/xena/
0 Thu Feb 23 16:50:50 EST 2006 au/gov/naa/digipres/xena/demo/
0 Thu Feb 23 16:50:56 EST 2006 au/gov/naa/digipres/xena/demo/foo/
15 Thu Feb 23 16:51:28 EST 2006 au/gov/naa/digipres/xena/demo/foo/preferences.properties
</pre>
</div>
So the initial set up is complete.
The code will start in the next chapter.
</div>



</body>
</html>
